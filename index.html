<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cafe POS">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Cafe POS System</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest-placeholder">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjZDkyNjIwIi8+PHRleHQgeD0iMTYiIHk9IjIyIiBmaWxsPSIjZmZmZmZmIiBmb250LXNpemU9IjE4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7imJU8L3RleHQ+PC9zdmc+">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIj48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2Q5MjYyMCIvPjx0ZXh0IHg9IjYwIiB5PSI3MCIgZmlsbD0iI2ZmZmZmZiIgZm9udC1zaXplPSI0MCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+IENhZmUgPC90ZXh0Pjwvc3ZnPg==">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* iPad optimizations */
        input, select, button {
            -webkit-appearance: none;
            border-radius: 8px;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        /* Touch-friendly sizing */
        button {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Print styles */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                background: white;
            }
            .no-print { display: none !important; }
        }
        

        

    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">




    <!-- Print Area (Hidden) -->
    <div id="printArea" style="display: none;"></div>

    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-amber-800 text-center">☕ Hope Cafe POS</h1>
            <div class="flex justify-center mt-4 space-x-4">
                <button id="billingTab" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 transition-colors">Billing</button>
                <button id="salesTab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">Sales History</button>
                <button id="menuTab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">Menu Management</button>
            </div>
        </div>

        <!-- Sales History Section -->
        <div id="salesSection" class="space-y-6 hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">📊 Sales History</h2>
                
                <!-- Daily Summary -->
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-green-800">Today's Sales</h3>
                        <p class="text-2xl font-bold text-green-600">₹<span id="todaysSales">0.00</span></p>
                        <p class="text-sm text-green-600"><span id="todaysOrders">0</span> orders</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-blue-800">Total Orders</h3>
                        <p class="text-2xl font-bold text-blue-600"><span id="totalOrders">0</span></p>
                        <p class="text-sm text-blue-600">All time</p>
                    </div>
                    <div class="bg-amber-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-amber-800">Average Order</h3>
                        <p class="text-2xl font-bold text-amber-600">₹<span id="averageOrder">0.00</span></p>
                        <p class="text-sm text-amber-600">Per order</p>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="mb-4">
                    <div class="flex space-x-4">
                        <select id="dateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button onclick="exportSalesData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">Export Data</button>
                        <button onclick="showDataLocationInfo()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium">Data Info</button>
                        <button onclick="clearAllSales()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium">Clear All Data</button>
                    </div>
                </div>

                <!-- Sales Table -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 rounded-lg">
                        <thead class="bg-amber-100">
                            <tr>
                                <th class="border border-gray-300 px-4 py-2 text-left">Order #</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Customer</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Date & Time</th>
                                <th class="border border-gray-300 px-4 py-2 text-center">Items</th>
                                <th class="border border-gray-300 px-4 py-2 text-right">Total</th>
                                <th class="border border-gray-300 px-4 py-2 text-center">Payment</th>
                            </tr>
                        </thead>
                        <tbody id="salesHistoryTable">
                            <tr>
                                <td colspan="6" class="border border-gray-300 px-4 py-8 text-center text-gray-500">No sales data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Menu Management Section -->
        <div id="menuSection" class="space-y-6 hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">📋 Menu Management</h2>
                
                <!-- Add Item Form -->
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Add New Item</h3>
                        <div class="space-y-3">
                            <input type="text" id="itemName" placeholder="Item Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <select id="itemCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                <option value="">Select Category</option>
                                <option value="Beverages">Beverages</option>
                                <option value="Food">Food</option>
                            </select>
                            <input type="number" id="itemPrice" placeholder="Price" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <button onclick="addMenuItem()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors font-medium">Add Item</button>
                        </div>
                    </div>
                    
                    <!-- Current Menu Display -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Current Menu</h3>
                        <div id="menuDisplay" class="bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto">
                            <p class="text-gray-500 text-center">No items added yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing Section -->
        <div id="billingSection" class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">🧾 New Order</h2>
                
                <!-- Order Header -->
                <div class="grid md:grid-cols-3 gap-4 mb-6 p-4 bg-amber-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Order Number</label>
                        <input type="text" id="orderNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                        <input type="text" id="customerName" placeholder="Enter customer name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                        <input type="text" id="orderDateTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                </div>

                <!-- Add Items Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Add Items to Order</h3>
                    <div class="grid md:grid-cols-4 gap-3 p-4 bg-gray-50 rounded-lg">
                        <select id="productSelect" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <option value="">Select Product</option>
                        </select>
                        <input type="number" id="quantity" placeholder="Quantity" min="1" value="1" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                        <div class="px-3 py-2 bg-white border border-gray-300 rounded-lg">
                            <span class="text-gray-600">Rate: ₹</span><span id="selectedRate">0.00</span>
                        </div>
                        <button onclick="addToOrder()" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">Add Item</button>
                    </div>
                </div>

                <!-- Order Items Table -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Order Items</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 rounded-lg">
                            <thead class="bg-amber-100">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Quantity</th>
                                    <th class="border border-gray-300 px-4 py-2 text-right">Rate</th>
                                    <th class="border border-gray-300 px-4 py-2 text-right">Amount</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsTable">
                                <tr>
                                    <td colspan="5" class="border border-gray-300 px-4 py-8 text-center text-gray-500">No items added to order</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Mode</label>
                            <select id="paymentMode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                <option value="Cash">Cash</option>
                                <option value="Online">Online</option>
                            </select>
                        </div>
                        <button onclick="completeOrder()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium text-lg">Complete & Print Order</button>
                        <button onclick="clearOrder()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors font-medium">Clear Order</button>
                    </div>
                    
                    <div class="bg-amber-50 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Order Summary</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span class="font-medium">₹<span id="subtotal">0.00</span></span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-amber-800 border-t pt-2">
                                <span>Total Amount:</span>
                                <span>₹<span id="totalAmount">0.00</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let menuItems = [];
        let orderItems = [];
        let orderCounter = 1;
        let deferredPrompt;
        let salesHistory = [];
        let selectedProductIndex = null;

        // Initialize the app with better error handling
        function initializeApp() {
            try {
                console.log('Starting Hope Cafe POS initialization...');
                
                // Basic initialization
                generateOrderNumber();
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                // Load data from localStorage
                loadDataFromStorage();
                
                // Load sample menu items if none exist
                if (menuItems.length === 0) {
                    loadSampleMenu();
                }
                
                // Setup core functionality
                setupTabSwitching();
                setupProductSelect();
                setupDateFilter();
                
                // Setup PWA features (non-blocking)
                setTimeout(() => {
                    try {
                        setupGitHubPagesPWA();
                        registerServiceWorker();
                        setupPWAInstall();
                    } catch (pwaError) {
                        console.log('PWA features failed, continuing with basic functionality:', pwaError);
                    }
                }, 100);
                
                console.log('Hope Cafe POS initialized successfully');
                return true;
            } catch (error) {
                console.error('Initialization error:', error);
                // Fallback initialization
                try {
                    generateOrderNumber();
                    updateDateTime();
                    loadSampleMenu();
                    setupTabSwitching();
                    console.log('Fallback initialization completed');
                    return true;
                } catch (fallbackError) {
                    console.error('Fallback initialization failed:', fallbackError);
                    return false;
                }
            }
        }

        // Multiple initialization attempts
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Backup initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Final fallback
        window.addEventListener('load', function() {
            setTimeout(initializeApp, 500);
        });



        // Simplified PWA setup
        function setupGitHubPagesPWA() {
            try {
                const manifest = {
                    name: "Hope Cafe POS",
                    short_name: "Cafe POS",
                    start_url: "./",
                    display: "standalone",
                    background_color: "#fffbf0",
                    theme_color: "#d92620",
                    icons: [{
                        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192'%3E%3Crect width='192' height='192' fill='%23d92620'/%3E%3Ctext x='96' y='120' fill='white' font-size='60' text-anchor='middle'%3E☕%3C/text%3E%3C/svg%3E",
                        sizes: "192x192",
                        type: "image/svg+xml"
                    }]
                };
                
                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestUrl = URL.createObjectURL(manifestBlob);
                
                const manifestLink = document.getElementById('manifest-placeholder');
                if (manifestLink) {
                    manifestLink.href = manifestUrl;
                }
                
                console.log('PWA manifest ready');
            } catch (error) {
                console.log('PWA setup skipped:', error);
            }
        }

        // Simple PWA install
        function setupPWAInstall() {
            try {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                });
                console.log('PWA install ready');
            } catch (error) {
                console.log('PWA install skipped:', error);
            }
        }

        // Simplified service worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'cafe-pos-v1';
                    
                    self.addEventListener('install', function(event) {
                        console.log('SW installing');
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', function(event) {
                        console.log('SW activating');
                        self.clients.claim();
                    });

                    self.addEventListener('fetch', function(event) {
                        // Let network handle all requests
                        event.respondWith(fetch(event.request));
                    });
                `;

                try {
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl)
                        .then(() => console.log('SW registered'))
                        .catch(() => console.log('SW registration failed'));
                } catch (error) {
                    console.log('SW setup failed:', error);
                }
            }
        }



        // Tab switching - moved inside DOMContentLoaded
        function setupTabSwitching() {
            try {
                document.getElementById('billingTab').addEventListener('click', function() {
                    showBillingSection();
                });

                document.getElementById('salesTab').addEventListener('click', function() {
                    showSalesSection();
                });

                document.getElementById('menuTab').addEventListener('click', function() {
                    showMenuSection();
                });
                
                console.log('Tab switching setup complete');
            } catch (error) {
                console.error('Tab switching setup error:', error);
            }
        }

        function showBillingSection() {
            document.getElementById('billingSection').classList.remove('hidden');
            document.getElementById('salesSection').classList.add('hidden');
            document.getElementById('menuSection').classList.add('hidden');
            setActiveTab('billingTab');
        }

        function showSalesSection() {
            document.getElementById('salesSection').classList.remove('hidden');
            document.getElementById('billingSection').classList.add('hidden');
            document.getElementById('menuSection').classList.add('hidden');
            setActiveTab('salesTab');
            updateSalesDisplay();
        }

        function showMenuSection() {
            document.getElementById('menuSection').classList.remove('hidden');
            document.getElementById('billingSection').classList.add('hidden');
            document.getElementById('salesSection').classList.add('hidden');
            setActiveTab('menuTab');
        }

        function setActiveTab(activeTabId) {
            const tabs = ['billingTab', 'salesTab', 'menuTab'];
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tabId === activeTabId) {
                    tab.classList.add('bg-amber-600', 'text-white');
                    tab.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    tab.classList.add('bg-gray-200', 'text-gray-700');
                    tab.classList.remove('bg-amber-600', 'text-white');
                }
            });
        }

        // Data Storage Functions
        function saveDataToStorage() {
            localStorage.setItem('hopeMenuItems', JSON.stringify(menuItems));
            localStorage.setItem('hopeSalesHistory', JSON.stringify(salesHistory));
            localStorage.setItem('hopeOrderCounter', orderCounter.toString());
        }

        function loadDataFromStorage() {
            const savedMenu = localStorage.getItem('hopeMenuItems');
            const savedSales = localStorage.getItem('hopeSalesHistory');
            const savedCounter = localStorage.getItem('hopeOrderCounter');

            if (savedMenu) {
                menuItems = JSON.parse(savedMenu);
                updateMenuDisplay();
                updateProductSelect();
            }

            if (savedSales) {
                salesHistory = JSON.parse(savedSales);
            }

            if (savedCounter) {
                orderCounter = parseInt(savedCounter);
            }
        }



        // Load sample menu items
        function loadSampleMenu() {
            const sampleItems = [
                { name: 'Espresso', category: 'Beverages', price: 80 },
                { name: 'Cappuccino', category: 'Beverages', price: 120 },
                { name: 'Latte', category: 'Beverages', price: 140 },
                { name: 'Cold Coffee', category: 'Beverages', price: 160 },
                { name: 'Tea', category: 'Beverages', price: 60 },
                { name: 'Sandwich', category: 'Food', price: 180 },
                { name: 'Burger', category: 'Food', price: 220 },
                { name: 'Pasta', category: 'Food', price: 280 },
                { name: 'Pizza Slice', category: 'Food', price: 150 },
                { name: 'Muffin', category: 'Food', price: 100 }
            ];

            sampleItems.forEach(item => {
                menuItems.push(item);
            });
            
            updateMenuDisplay();
            updateProductSelect();
        }

        // Menu Management Functions
        function addMenuItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const price = parseFloat(document.getElementById('itemPrice').value);

            if (!name || !category || !price || price <= 0) {
                alert('Please fill all fields with valid values');
                return;
            }

            const newItem = { name, category, price };
            menuItems.push(newItem);
            
            updateMenuDisplay();
            updateProductSelect();
            saveDataToStorage();
            
            // Clear form
            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemPrice').value = '';
        }

        function updateMenuDisplay() {
            const menuDisplay = document.getElementById('menuDisplay');
            
            if (menuItems.length === 0) {
                menuDisplay.innerHTML = '<p class="text-gray-500 text-center">No items added yet</p>';
                return;
            }

            const beverages = menuItems.filter(item => item.category === 'Beverages');
            const food = menuItems.filter(item => item.category === 'Food');

            let html = '';
            
            if (beverages.length > 0) {
                html += '<div class="mb-4"><h4 class="font-semibold text-amber-700 mb-2">☕ Beverages</h4>';
                beverages.forEach((item, index) => {
                    html += `<div class="flex justify-between items-center py-1">
                        <span>${item.name}</span>
                        <div>
                            <span class="font-medium">₹${item.price}</span>
                            <button onclick="removeMenuItem(${menuItems.indexOf(item)})" class="ml-2 text-red-600 hover:text-red-800">×</button>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            if (food.length > 0) {
                html += '<div><h4 class="font-semibold text-amber-700 mb-2">🍽️ Food</h4>';
                food.forEach((item, index) => {
                    html += `<div class="flex justify-between items-center py-1">
                        <span>${item.name}</span>
                        <div>
                            <span class="font-medium">₹${item.price}</span>
                            <button onclick="removeMenuItem(${menuItems.indexOf(item)})" class="ml-2 text-red-600 hover:text-red-800">×</button>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            menuDisplay.innerHTML = html;
        }

        function removeMenuItem(index) {
            menuItems.splice(index, 1);
            updateMenuDisplay();
            updateProductSelect();
            saveDataToStorage();
        }

        function updateProductSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">Select Product</option>';
            
            menuItems.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${item.name} - ₹${item.price}`;
                select.appendChild(option);
            });
        }

        // Billing Functions
        function generateOrderNumber() {
            const orderNum = `ORD${String(orderCounter).padStart(4, '0')}`;
            document.getElementById('orderNumber').value = orderNum;
        }

        function updateDateTime() {
            const now = new Date();
            const dateTime = now.toLocaleString('en-IN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('orderDateTime').value = dateTime;
        }

        // Update rate when product is selected - moved to setup function
        function setupProductSelect() {
            try {
                document.getElementById('productSelect').addEventListener('change', function() {
                    const selectedIndex = this.value;
                    const rateSpan = document.getElementById('selectedRate');
                    
                    if (selectedIndex === '') {
                        rateSpan.textContent = '0.00';
                        selectedProductIndex = null;
                    } else {
                        selectedProductIndex = parseInt(selectedIndex);
                        const selectedItem = menuItems[selectedIndex];
                        rateSpan.textContent = selectedItem.price.toFixed(2);
                    }
                });
                
                console.log('Product select setup complete');
            } catch (error) {
                console.error('Product select setup error:', error);
            }
        }

        function addToOrder() {
            const quantity = parseInt(document.getElementById('quantity').value);

            if (selectedProductIndex === null || !quantity || quantity <= 0) {
                alert('Please select a product and enter valid quantity');
                return;
            }

            const product = menuItems[selectedProductIndex];
            const amount = product.price * quantity;

            const orderItem = {
                name: product.name,
                quantity: quantity,
                rate: product.price,
                amount: amount
            };

            orderItems.push(orderItem);
            updateOrderTable();
            updateOrderSummary();

            // Reset form
            document.getElementById('productSelect').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('selectedRate').textContent = '0.00';
            selectedProductIndex = null;
        }

        function updateOrderTable() {
            const tbody = document.getElementById('orderItemsTable');
            
            if (orderItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="border border-gray-300 px-4 py-8 text-center text-gray-500">No items added to order</td></tr>';
                return;
            }

            let html = '';
            orderItems.forEach((item, index) => {
                html += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${item.name}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${item.quantity}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">₹${item.rate.toFixed(2)}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">₹${item.amount.toFixed(2)}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <button onclick="removeOrderItem(${index})" class="text-red-600 hover:text-red-800 font-medium">Remove</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function removeOrderItem(index) {
            orderItems.splice(index, 1);
            updateOrderTable();
            updateOrderSummary();
        }

        function updateOrderSummary() {
            const subtotal = orderItems.reduce((sum, item) => sum + item.amount, 0);
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('totalAmount').textContent = subtotal.toFixed(2);
        }

        function completeOrder() {
            const customerName = document.getElementById('customerName').value.trim();
            const paymentMode = document.getElementById('paymentMode').value;

            if (!customerName) {
                alert('Please enter customer name');
                return;
            }

            if (orderItems.length === 0) {
                alert('Please add items to the order');
                return;
            }

            // Save order to sales history
            const orderData = {
                orderNumber: document.getElementById('orderNumber').value,
                customerName: customerName,
                dateTime: document.getElementById('orderDateTime').value,
                items: [...orderItems],
                total: parseFloat(document.getElementById('totalAmount').textContent),
                paymentMode: paymentMode,
                timestamp: new Date().getTime()
            };

            salesHistory.push(orderData);
            saveDataToStorage();

            // Generate and print receipt
            printReceipt();

            // Reset for next order
            orderCounter++;
            clearOrder();
            generateOrderNumber();
        }

        // Sales History Functions
        function updateSalesDisplay() {
            const filter = document.getElementById('dateFilter').value;
            const filteredSales = filterSalesByDate(filter);
            
            updateSalesSummary(filteredSales);
            updateSalesTable(filteredSales);
        }

        function filterSalesByDate(filter) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return salesHistory.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                
                switch(filter) {
                    case 'today':
                        return saleDate >= today;
                    case 'week':
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return saleDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                        return saleDate >= monthAgo;
                    default:
                        return true;
                }
            });
        }

        function updateSalesSummary(filteredSales) {
            const totalSales = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalOrders = filteredSales.length;
            const averageOrder = totalOrders > 0 ? totalSales / totalOrders : 0;

            document.getElementById('todaysSales').textContent = totalSales.toFixed(2);
            document.getElementById('todaysOrders').textContent = totalOrders;
            document.getElementById('totalOrders').textContent = salesHistory.length;
            document.getElementById('averageOrder').textContent = averageOrder.toFixed(2);
        }

        function updateSalesTable(filteredSales) {
            const tbody = document.getElementById('salesHistoryTable');
            
            if (filteredSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="border border-gray-300 px-4 py-8 text-center text-gray-500">No sales data available</td></tr>';
                return;
            }

            let html = '';
            filteredSales.reverse().forEach(sale => {
                const itemCount = sale.items.reduce((sum, item) => sum + item.quantity, 0);
                html += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${sale.orderNumber}</td>
                        <td class="border border-gray-300 px-4 py-2">${sale.customerName}</td>
                        <td class="border border-gray-300 px-4 py-2">${sale.dateTime}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${itemCount}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">₹${sale.total.toFixed(2)}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${sale.paymentMode}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function clearAllSales() {
            if (confirm('Are you sure you want to clear all sales data? This cannot be undone.')) {
                salesHistory = [];
                orderCounter = 1;
                saveDataToStorage();
                updateSalesDisplay();
                generateOrderNumber();
                alert('All sales data has been cleared.');
            }
        }

        // Export sales data as JSON file
        function exportSalesData() {
            const exportData = {
                salesHistory: salesHistory,
                menuItems: menuItems,
                orderCounter: orderCounter,
                exportDate: new Date().toISOString(),
                cafeInfo: {
                    name: "Hope Cafe",
                    version: "1.0"
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `hope-cafe-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ Data exported successfully!\n\nFile saved to Downloads folder.\nKeep this backup safe for data recovery.');
        }

        // Show data location info
        function showDataLocationInfo() {
            const info = `
📱 HOPE CAFE POS - DATA STORAGE INFO

💾 WHERE YOUR DATA IS STORED:
• All sales, menu items, and settings are stored locally on your iPad
• Data location: Safari Browser Storage (LocalStorage)
• No data is sent to external servers - completely private!

📁 BACKUP & EXPORT:
• Use "Export Data" button to download backup files
• Backup files are saved to your iPad's Downloads folder
• File format: JSON (can be opened with any text editor)

🔄 DATA RECOVERY:
• Your data persists even when offline
• Data remains when you close and reopen the app
• To restore: Keep backup files safe in Files app

📊 WHAT'S INCLUDED IN BACKUPS:
• All sales history and receipts
• Complete menu items and prices
• Order counter and settings
• Export date and version info

💡 BEST PRACTICES:
• Export data weekly for safety
• Store backup files in iCloud Drive
• Keep multiple backup copies
• Test restore process occasionally

🔒 PRIVACY:
• All data stays on your device
• No internet required after installation
• Complete data ownership and control
            `;
            alert(info);
        }

        // Setup date filter - moved to setup function
        function setupDateFilter() {
            try {
                document.getElementById('dateFilter').addEventListener('change', updateSalesDisplay);
                console.log('Date filter setup complete');
            } catch (error) {
                console.error('Date filter setup error:', error);
            }
        }

        function printReceipt() {
            const orderNumber = document.getElementById('orderNumber').value;
            const customerName = document.getElementById('customerName').value;
            const orderDateTime = document.getElementById('orderDateTime').value;
            const paymentMode = document.getElementById('paymentMode').value;
            const total = document.getElementById('totalAmount').textContent;

            // Create receipt HTML optimized for desktop printing
            let receiptHTML = `
                <div style="width: 300px; margin: 0 auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #000; background: #fff; padding: 20px;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                        <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">☕ HOPE CAFE</div>
                        <div style="font-size: 12px; margin-bottom: 2px;">123 Main Street, Your City</div>
                        <div style="font-size: 12px; margin-bottom: 2px;">Phone: +91 98765 43210</div>
                        <div style="font-size: 12px;">Email: info@hopecafe.com</div>
                    </div>
                    
                    <!-- Order Details -->
                    <div style="margin-bottom: 15px; font-size: 11px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <strong>Order #:</strong> <span>${orderNumber}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <strong>Customer:</strong> <span>${customerName}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <strong>Date:</strong> <span>${new Date().toLocaleDateString('en-IN')}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <strong>Time:</strong> <span>${new Date().toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <strong>Payment:</strong> <span>${paymentMode}</span>
                        </div>
                    </div>
                    
                    <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div>
                    
                    <!-- Items Header -->
                    <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #000; padding-bottom: 5px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="width: 45%;">ITEM</span>
                            <span style="width: 15%; text-align: center;">QTY</span>
                            <span style="width: 20%; text-align: right;">RATE</span>
                            <span style="width: 20%; text-align: right;">AMOUNT</span>
                        </div>
                    </div>
                    
                    <!-- Items List -->
                    <div style="margin-bottom: 15px;">`;

            orderItems.forEach(item => {
                receiptHTML += `
                    <div style="font-size: 11px; margin-bottom: 5px; padding: 3px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="width: 45%; font-weight: 500;">${item.name}</span>
                            <span style="width: 15%; text-align: center;">${item.quantity}</span>
                            <span style="width: 20%; text-align: right;">₹${item.rate.toFixed(2)}</span>
                            <span style="width: 20%; text-align: right; font-weight: bold;">₹${item.amount.toFixed(2)}</span>
                        </div>
                    </div>`;
            });

            receiptHTML += `
                    </div>
                    
                    <div style="border-top: 2px solid #000; margin: 15px 0; padding-top: 10px;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: bold;">
                            <span>TOTAL AMOUNT:</span>
                            <span>₹${total}</span>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="text-align: center; font-size: 11px; margin-top: 20px; border-top: 1px dashed #000; padding-top: 15px;">
                        <div style="margin-bottom: 5px; font-weight: bold;">Thank you for visiting Hope Cafe!</div>
                        <div style="margin-bottom: 5px;">We appreciate your business</div>
                        <div style="margin-bottom: 10px;">Please visit us again soon</div>
                        <div style="font-size: 9px; color: #666;">Powered by Hope Cafe POS System</div>
                    </div>
                </div>
            `;

            // Set the print area content
            document.getElementById('printArea').innerHTML = receiptHTML;
            document.getElementById('printArea').style.display = 'block';
            
            // Print the receipt
            window.print();
            
            // Hide print area after printing
            setTimeout(() => {
                document.getElementById('printArea').style.display = 'none';
            }, 1000);
        }

        // Bluetooth thermal printer support
        async function printToBluetoothPrinter(receiptHTML) {
            try {
                // Check if Web Bluetooth is supported
                if (!navigator.bluetooth) {
                    console.log('Web Bluetooth not supported, using regular print');
                    window.print();
                    return;
                }

                // For now, use regular print as Web Bluetooth has limited support
                // In a real implementation, you would connect to the specific printer
                console.log('Bluetooth printing attempted - using fallback print');
                window.print();
                
                // Show helpful message for Bluetooth printing
                setTimeout(() => {
                    if (confirm('For Bluetooth printing:\n\n1. Ensure your thermal printer is paired with this device\n2. Use your device\'s print dialog to select the Bluetooth printer\n3. Set paper size to 58mm or 80mm thermal\n\nWould you like to see printing tips?')) {
                        showPrintingTips();
                    }
                }, 1000);

            } catch (error) {
                console.log('Bluetooth printing failed, using regular print:', error);
                window.print();
            }
        }

        function showPrintingTips() {
            const tips = `
📱 THERMAL PRINTER SETUP TIPS:

🔗 BLUETOOTH CONNECTION:
• Pair your thermal printer in device settings
• Ensure printer is turned on and ready

🖨️ PRINT SETTINGS:
• Paper Size: 58mm or 80mm thermal
• Margins: None or Minimum
• Scale: 100% or Fit to Page
• Quality: Draft or Fast

📋 PRINTER COMPATIBILITY:
• ESC/POS compatible printers work best
• Your Shreyans thermal printer supports standard commands
• Use "Print" option and select your Bluetooth printer

⚡ TROUBLESHOOTING:
• If receipt is cut off, try "Fit to Page"
• For better quality, use "More Settings" → "Graphics"
• Ensure printer has paper and is not in error state

💡 TIP: Save this page as bookmark for easy access!
            `;
            alert(tips);
        }

        function clearOrder() {
            orderItems = [];
            document.getElementById('customerName').value = '';
            document.getElementById('paymentMode').value = 'Cash';
            document.getElementById('productSelect').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('selectedRate').textContent = '0.00';
            selectedProductIndex = null;
            updateOrderTable();
            updateOrderSummary();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966d9c8700049638',t:'MTc1MzgwMjU0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
